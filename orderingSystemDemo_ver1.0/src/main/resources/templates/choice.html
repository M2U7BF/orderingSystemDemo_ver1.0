<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>購入食材の選択 | 株式会社ニーズ＆フーズ</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <h1>購入食材の選択</h1>
    <div>
        <p>購入者 : <span th:text="${user.name}">購入者の名前</span></p>
    </div>
    <h2>食材一覧</h2>
    <div>
        <p>今の時期に流通している主な食材を表示しています。<br>表記のない食材についてはこちらにてご注文ください。</p><br>
        <p>追加するにはクリックをしてください。</p>
    </div>
    <h3>野菜</h3>
    <table>
        <tr>
            <th>食材名</th>
            <th>単位</th>
            <th>値段(円)</th>
        </tr>
        <!-- TODO 今の季節に取り扱う食材をリストで入手 -->
        <th:block th:each="veg : ${vegetables}">
        <tr class="foodListItem" data-id="0" th:data-id="*{id}" th:object="${veg}">
            <td class="name" th:text="*{name}">食材名</td>
            <td class="salesUnit" th:text="*{salesUnit}">取り扱い単位</td>
            <td class="price" th:text="*{price}">値段</td>
        </tr>
        </th:block>
    </table>
    <h3>果物</h3>
    <table>
        <tr>
            <th>食材名</th>
            <th>単位</th>
            <th>値段(円)</th>
        </tr>
        <th:block th:each="frt : ${fruits}">
        <tr class="foodListItem" data-id="0" th:data-id="*{id}" th:object="${frt}">
            <td class="name" th:text="*{name}">食材名</td>
            <td class="salesUnit" th:text="*{salesUnit}">取り扱い単位</td>
            <td class="price" th:text="*{price}">値段</td>
        </tr>
        </th:block>
    </table>
    <!-- TODO デフォルト、選択していませんの表示 -->
    <h2>選択した食材</h2>
    <form action="" th:action="@{confirm}" method="post">
        <table id="foodList">
            <tr>
                <th>食材名</th>
                <th>単位</th>
                <th>値段(円)</th>
                <th>購入個数</th>
                <th>購入金額(円)(税抜)</th>
            </tr>
        </table>
        <h2>合計:
            <span id="grandTotal" th:text="0">合計金額</span>円(税込み)
            <input id="grandTotal_input" type="hidden" name="grandTotal" value="">
        </h2>
        <!-- <a href="confirm.html" th:href="@{confirm}"></a> -->
        <input type="submit" value="確認画面に進む">
    </form>

    <a href="service.html" th:href="@{service}">戻る</a></li>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script type="text/javascript">
        // <!--
        $(function () {
            $(".foodListItem").click(function () {
                let id;
                id = $(this).data("id");

                if (!($("#selectedItem" + id).length)) {
                    let name;
                    let salesUnit;
                    let price;
                    
                    name = $(".foodListItem[data-id="+id+"]").children(".name").text();
                    salesUnit = $(".foodListItem[data-id="+id+"]").children(".salesUnit").text();
                    price = $(".foodListItem[data-id="+id+"]").children(".price").text();

                    $("#foodList").append(
                        "\<tr class=\"selectedItem\" id=\"selectedItem" + id + "\"\>" +
                        "\<td\>"+
                            name+
                            "<input type=\"hidden\" name=\"name\" value=\""+name+"\">"+
                        "\<\/td\>" +
                        "\<td\>"+
                            salesUnit+
                            "<input type=\"hidden\" name=\"salesUnit\" value=\""+salesUnit+"\">"+
                        "\<\/td\>" +
                        "\<td\>"+
                            price+
                            "<input type=\"hidden\" name=\"price\" value=\""+price+"\">"+
                        "\<\/td\>" +
                        "\<td\>"+
                            "\<select name=\"numPurchase\" id=\"numPurchases" + id + "\" onchange=\"calcTotal(" + price + "," + id + ")\" placeholder='個数'\>"+
                                "\<option\>0\<\/option\>"+
                                "\<option\>1\<\/option\>"+
                                "\<option\>2\<\/option\>"+
                                "\<option\>3\<\/option\>"+
                                "\<option\>4\<\/option\>"+
                                "\<option\>5\<\/option\>"+
                                "\<option\>6\<\/option\>"+
                                "\<option\>7\<\/option\>"+
                                "\<option\>8\<\/option\>"+
                                "\<option\>9\<\/option\>"+
                                "\<option\>10\<\/option\>"+
                                "\<option\>11\<\/option\>"+
                                "\<option\>12\<\/option\>"+
                                "\<option\>13\<\/option\>"+
                                "\<option\>14\<\/option\>"+
                                "\<option\>15\<\/option\>"+
                            "\<\/select\>"+
                        "\<\/td\>" +
                        "\<td\>"+
                            "<span id=\"total" + id + "\" class=\"total\" >0</span>"+
                            "<input type=\"hidden\" name=\"total\" id=\"total_input" + id + "\" value=\"00\" \>"+
                        "\<\/td\>" +
                        "\<td\>\<button onclick=\"removeItem(this," + id + ")\" class=\"deleteButton\"\>削除する\<\/button\>\<\/td\>" +
                        "\<\/tr\>");
                }
            });
        });

        function removeItem(button, id) {
            let parent = button.parentNode.parentNode;
            parent.remove();

            calcGrandTotal();
        }

        function calcTotal(price, id) {
            let amount = $("#numPurchases" + id).val();
            let total = Math.ceil(price * amount);

            $("#total" + id).text(total);
            $("#total_input" + id).attr('value',total);

            calcGrandTotal();
        }

        function calcGrandTotal(){
            let grandTotal = 0;
            $(".total").each(function (i, element) {
                let text = Number($(element).text());
                grandTotal += text;
            });
            grandTotal = Math.round(grandTotal * 1.08);
            $("#grandTotal").text(grandTotal);
            $("#grandTotal_input").attr("value",grandTotal);
        }
    //-->

    </script>
</body>

</html>